<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Camera</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            color: slategray;
            margin: 0;
            background-color: #000000;
            text-align: center;
        }
        .wifi-bars {
            display: inline-flex;
            align-items: flex-end;
            margin-right: 8px;
            height: 16px;
        }
        .wifi-bar {
            width: 3px;
            margin-right: 2px;
            background-color: #ddd;
            border-radius: 1px;
            transition: background-color 0.3s ease;
        }
        .wifi-bar:nth-child(1) { height: 4px; }
        .wifi-bar:nth-child(2) { height: 8px; }
        .wifi-bar:nth-child(3) { height: 12px; }
        .wifi-bar:nth-child(4) { height: 16px; }
        .wifi-excellent {
            border-color: #28a745;
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        .wifi-good {
            border-color: #17a2b8;
            color: #17a2b8;
            background: rgba(23, 162, 184, 0.1);
        }
        .wifi-fair {
            border-color: #ffc107;
            color: #e67e00;
            background: rgba(255, 193, 7, 0.1);
        }
        .wifi-weak {
            border-color: #fd7e14;
            color: #fd7e14;
            background: rgba(253, 126, 20, 0.1);
        }
        .wifi-poor {
            border-color: #dc3545;
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        .wifi-unknown {
            border-color: #6c757d;
            color: #6c757d;
            background: rgba(108, 117, 125, 0.1);
        }
        .container {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            background-color: black;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #ffffff;
            margin-bottom: 20px;
        }
        .camera-stream {
            border: 2px solid #ddd;
            border-radius: 5px;
            width: 100%;
            max-width: 1000px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        .video-container {
            position: relative;
            margin: 20px 0;
            text-align: center;
        }
        .video-section {
            margin-bottom: 20px;
        }
        .info {
            margin-top: 20px;
            padding: 15px;
            background-color: #000000;
            border-radius: 5px;
            color: #slategray;
            text-align: left;
        }
        .info p {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .signal-excellent { color: #28a745; font-weight: bold; }
        .signal-good { color: #17a2b8; font-weight: bold; }
        .signal-fair { color: #ffc107; font-weight: bold; }
        .signal-weak { color: #fd7e14; font-weight: bold; }
        .signal-poor { color: #dc3545; font-weight: bold; }
        .status-running { color: #28a745; font-weight: bold; }
        .status-stopped { color: #dc3545; font-weight: bold; }
        .controls {
            margin-top: 15px;
        }
        .recording-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            min-width: 120px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .record-button {
            background-color: #09454F;
            transition: background-color 0.3s ease;
        }
        .record-button:hover:not(:disabled) {
            background-color: #073038;
        }
        .record-button.recording {
            background-color: #A8192A;
        }
        .record-button.recording:hover:not(:disabled) {
            background-color: #70111C;
        }
        .record-button.processing {
            background-color: #A8192A;
        }
        .recording-status {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            color: #856404;
            text-align: center;
        }
        .recording-status.active {
            background-color: #3A4142;
            border-color: #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">

        <div class="video-section">
            <div class="video-container" style="position: relative;">
                <img id="camera-stream" class="camera-stream" alt="Camera Stream" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                <div id="datetime-overlay" style="position: absolute; bottom: 10px; right: 10px; background: rgba(0, 0, 0, 0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-family: monospace;"></div>
            </div>
        </div>

        <div id="recording-status" class="recording-status" style="display: none;">
            <span id="recording-text">Recording: 00:00</span>
        </div>

        <div class="info">
            <p style="display: flex; justify-content: space-between; align-items: center;"><strong>WiFi Signal:</strong> <span style="display: flex; align-items: center; gap: 8px;"><span class="wifi-bars" id="wifi-bars" style="display: inline-flex; align-items: baseline;"><span class="wifi-bar"></span><span class="wifi-bar"></span><span class="wifi-bar"></span><span class="wifi-bar"></span></span><span id="wifi-signal">Loading...</span></span></p>
            <p><strong>CPU Temperature:</strong> <span id="cpu-temp">Loading...</span></p>
            <p><strong>Uptime:</strong> <span id="uptime">Loading...</span></p>
            <p><strong>Door Status:</strong> <span id="door-status" style="font-weight: bold;">No data</span></p>
            <p><strong>Nextcloud Files:</strong></p>
            <p style="margin-left: 20px;">
                <a href="#" id="motion-captures-link" target="_blank" style="color: #17a2b8; text-decoration: none;">Motion Captures</a><br>
                <a href="#" id="recordings-link" target="_blank" style="color: #17a2b8; text-decoration: none;">Video Recordings</a>
            </p>
        </div>

        <!-- Recording Controls -->
        <div class="recording-controls">
            <button id="record-toggle-btn" class="record-button" onclick="toggleRecording()">Start Recording</button>
        </div>
    </div>

    <!-- Socket.io client -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Connect to Socket.io server
        const socket = io();

        let framesReceived = 0;
        let lastFrameTime = Date.now();

        // Receive frames via Socket.io
        socket.on('frame', (data) => {
            const img = document.getElementById('camera-stream');
            img.src = 'data:image/jpeg;base64,' + data.frame;

            framesReceived++;
            lastFrameTime = Date.now();

            if (framesReceived % 100 === 0) {
                console.log(`ðŸ“Š Received ${framesReceived} frames`);
            }
        });

        // Receive status updates via Socket.io
        socket.on('status', (data) => {
            updateStatus();
        });

        // Receive door status updates
        socket.on('door-status', (data) => {
            updateDoorStatus(data);
        });

        // Function to update system status
        function updateStatus() {
            fetch('/status')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Update WiFi bars in info section
                    const wifiBars = document.querySelectorAll('#wifi-bars .wifi-bar');
                    const wifiBarsContainer = document.getElementById('wifi-bars');

                    let barsToFill = 0;
                    let qualityClass = 'wifi-unknown';

                    if (data.wifi_signal_dbm !== null) {
                        const quality = data.wifi_signal_quality.toLowerCase();

                        // Determine number of bars to fill
                        switch(quality) {
                            case 'excellent':
                                qualityClass = 'wifi-excellent';
                                barsToFill = 4;
                                break;
                            case 'good':
                                qualityClass = 'wifi-good';
                                barsToFill = 3;
                                break;
                            case 'fair':
                                qualityClass = 'wifi-fair';
                                barsToFill = 2;
                                break;
                            case 'weak':
                                qualityClass = 'wifi-weak';
                                barsToFill = 1;
                                break;
                            case 'poor':
                                qualityClass = 'wifi-poor';
                                barsToFill = 1;
                                break;
                            default:
                                qualityClass = 'wifi-unknown';
                                barsToFill = 0;
                        }
                    }

                    // Apply quality class to bars container
                    wifiBarsContainer.className = `wifi-bars ${qualityClass}`;

                    // Update signal bars
                    wifiBars.forEach((bar, index) => {
                        if (index < barsToFill) {
                            // Get color from the container's computed style
                            const containerStyle = getComputedStyle(wifiBarsContainer);
                            const color = containerStyle.color;
                            bar.style.backgroundColor = color;
                        } else {
                            // Leave unfilled bars gray
                            bar.style.backgroundColor = '#ddd';
                        }
                    });

                    const signalEl = document.getElementById('wifi-signal');
                    if (signalEl) {
                        let signalText = 'Unknown';
                        let signalClass = '';

                        if (data.wifi_signal_dbm !== null) {
                            signalText = `${data.wifi_signal_quality} (${data.wifi_signal_dbm} dBm, ${data.wifi_signal_percent}%)`;
                            signalClass = `signal-${data.wifi_signal_quality.toLowerCase()}`;
                        }

                        signalEl.textContent = signalText;
                        signalEl.className = signalClass;
                    }

                    const tempEl = document.getElementById('cpu-temp');
                    if (tempEl) {
                        tempEl.textContent = data.cpu_temp || 'Unknown';
                    }

                    const uptimeEl = document.getElementById('uptime');
                    if (uptimeEl) {
                        uptimeEl.textContent = data.uptime || 'Unknown';
                    }

                    // Update Nextcloud links
                    updateNextcloudLinks(data);

                    // Update webhook data
                    updateWebhookData();
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                });
        }

        function updateWebhookData() {
            fetch('/door-status')
                .then(response => response.json())
                .then(data => {
                    updateDoorStatus(data);
                })
                .catch(error => {
                    console.error('Error fetching door status:', error);
                });
        }

        function formatTimeAgo(seconds) {
            if (seconds < 60) {
                // Less than 1 minute: show seconds
                return `${Math.floor(seconds)}s ago`;
            } else if (seconds < 3600) {
                // Less than 1 hour: show minutes
                const minutes = Math.floor(seconds / 60);
                return `${minutes}m ago`;
            } else if (seconds < 86400) {
                // Less than 1 day: show hours and minutes
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                if (minutes > 0) {
                    return `${hours}h ${minutes}m ago`;
                } else {
                    return `${hours}h ago`;
                }
            } else {
                // 1 day or more: show days and hours
                const days = Math.floor(seconds / 86400);
                const hours = Math.floor((seconds % 86400) / 3600);
                if (hours > 0) {
                    return `${days}d ${hours}h ago`;
                } else {
                    return `${days}d ago`;
                }
            }
        }

        function updateDoorStatus(data) {
            const doorStatusEl = document.getElementById('door-status');
            if (doorStatusEl) {
                if (data.door_state !== null) {
                    const timeAgo = data.time_ago ? data.time_ago : 0;
                    const timeAgoFormatted = formatTimeAgo(timeAgo);
                    const state = data.door_state.toUpperCase();
                    const stateColor = data.door_state === 'open' ? '#dc3545' : '#28a745';
                    doorStatusEl.innerHTML = `<span style="color: ${stateColor};">${state}</span> (${timeAgoFormatted})`;
                } else {
                    doorStatusEl.textContent = 'No data';
                    doorStatusEl.style.color = '#6c757d';
                }
            }
        }

        // Wait for page to load before updating status
        document.addEventListener('DOMContentLoaded', function() {
            // Update status immediately and then every 20 seconds
            updateStatus();
            setInterval(updateStatus, 20000);
        });

        // Function to update date and time overlay
        function updateDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');

            // Convert to 12-hour format
            let hours = now.getHours();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            const hoursFormatted = String(hours).padStart(2, '0');

            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            const dateTimeString = `${year}-${month}-${day} ${hoursFormatted}:${minutes}:${seconds} ${ampm}`;
            const overlay = document.getElementById('datetime-overlay');
            if (overlay) {
                overlay.textContent = dateTimeString;
            }
        }

        // Recording functions
        function toggleRecording() {
            const recordBtn = document.getElementById('record-toggle-btn');
            const isRecording = recordBtn.classList.contains('recording');

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            const recordBtn = document.getElementById('record-toggle-btn');

            // Immediate UI feedback
            recordBtn.disabled = true;
            recordBtn.classList.add('processing');
            recordBtn.textContent = 'Starting...';

            fetch('/start-recording', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        recordBtn.disabled = false;
                        recordBtn.classList.remove('processing');
                        recordBtn.classList.add('recording');
                        recordBtn.textContent = 'Stop Recording (00:00)';
                        startRecordingTimer();
                    } else {
                        resetRecordButton();
                    }
                })
                .catch(error => {
                    resetRecordButton();
                });
        }

        function stopRecording() {
            const recordBtn = document.getElementById('record-toggle-btn');

            // Immediate UI feedback
            recordBtn.disabled = true;
            recordBtn.classList.add('processing');
            recordBtn.textContent = 'Stopping...';

            fetch('/stop-recording', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    stopRecordingTimer();
                    resetRecordButton();
                })
                .catch(error => {
                    stopRecordingTimer();
                    resetRecordButton();
                });
        }

        function resetRecordButton() {
            const recordBtn = document.getElementById('record-toggle-btn');
            stopRecordingTimer();
            recordBtn.disabled = false;
            recordBtn.classList.remove('recording', 'processing');
            recordBtn.textContent = 'Start Recording';
        }

        function updateRecordingUI(isRecording, duration = 0) {
            const recordBtn = document.getElementById('record-toggle-btn');
            const statusDiv = document.getElementById('recording-status');
            const statusText = document.getElementById('recording-text');

            if (isRecording) {
                // Don't update button if it's in processing state
                if (!recordBtn.classList.contains('processing')) {
                    recordBtn.classList.add('recording');

                    // Start timer if not already running and we don't have a local timer
                    if (!recordingStartTime) {
                        recordingStartTime = Date.now() - (duration * 1000);
                        if (!recordingTimerInterval) {
                            recordingTimerInterval = setInterval(updateRecordingTimer, 1000);
                        }
                    }
                }

                statusDiv.style.display = 'block';
                statusDiv.classList.add('active');

                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                statusText.textContent = `Recording: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                // Don't update button if it's in processing state
                if (!recordBtn.classList.contains('processing')) {
                    recordBtn.classList.remove('recording');
                    recordBtn.textContent = 'Start Recording';
                    stopRecordingTimer();
                }

                statusDiv.style.display = 'none';
                statusDiv.classList.remove('active');
            }
        }

        // Recording timer variables
        let recordingStartTime = null;
        let recordingTimerInterval = null;

        function startRecordingTimer() {
            recordingStartTime = Date.now();
            recordingTimerInterval = setInterval(updateRecordingTimer, 1000);
        }

        function stopRecordingTimer() {
            if (recordingTimerInterval) {
                clearInterval(recordingTimerInterval);
                recordingTimerInterval = null;
            }
            recordingStartTime = null;
        }

        function updateRecordingTimer() {
            if (recordingStartTime && recordingTimerInterval) {
                const recordBtn = document.getElementById('record-toggle-btn');
                if (recordBtn.classList.contains('recording') && !recordBtn.classList.contains('processing')) {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    recordBtn.textContent = `Stop Recording (${timeString})`;
                }
            }
        }

        function updateNextcloudLinks(data) {
            const motionLink = document.getElementById('motion-captures-link');
            const recordingsLink = document.getElementById('recordings-link');

            if (!motionLink || !recordingsLink) {
                return;
            }

            if (data.nextcloud_enabled && data.nextcloud_config) {
                const baseUrl = data.nextcloud_config.url;
                const motionFolder = data.nextcloud_config.folder || '/motion_captures';
                const videoFolder = data.nextcloud_config.video_folder || '/recordings';

                // Construct Nextcloud web interface URLs
                const motionUrl = `${baseUrl}/index.php/apps/files/?dir=${encodeURIComponent(motionFolder)}`;
                const recordingsUrl = `${baseUrl}/index.php/apps/files/?dir=${encodeURIComponent(videoFolder)}`;

                motionLink.href = motionUrl;
                recordingsLink.href = recordingsUrl;
                motionLink.style.color = '#17a2b8';
                recordingsLink.style.color = '#17a2b8';
                motionLink.textContent = 'Motion Captures';
                recordingsLink.textContent = 'Video Recordings';
            } else {
                motionLink.href = '#';
                recordingsLink.href = '#';
                motionLink.style.color = '#6c757d';
                recordingsLink.style.color = '#6c757d';
                motionLink.textContent = 'Motion Captures (Nextcloud disabled)';
                recordingsLink.textContent = 'Video Recordings (Nextcloud disabled)';
            }
        }

        // Update datetime immediately and then every second
        updateDateTime();
        setInterval(updateDateTime, 1000);
    </script>
</body>
</html>
